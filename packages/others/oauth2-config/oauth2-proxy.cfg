# Configuration oauth2-proxy
# Feature 002 : oauth2-proxy-configuration
#
# Ce fichier contient la configuration complète d'oauth2-proxy.
# Format TOML (requis par oauth2-proxy pour les fichiers de configuration).
#
# Note : Les secrets (client_secret, cookie_secret) sont gérés
# de manière sécurisée via des variables d'environnement dans docker-compose.yml.
# Les secrets sont stockés dans le fichier .env (non versionné) et référencés
# via ${OAUTH2_PROXY_CLIENT_SECRET} et ${OAUTH2_PROXY_COOKIE_SECRET}.
# Voir la tâche 002-11-configure-secrets-management pour plus de détails.

# Provider OIDC
provider = "keycloak-oidc"

# Configuration OIDC Keycloak
client_id = "oauth-starter-client"
# client_secret : Géré via variable d'environnement OAUTH2_PROXY_CLIENT_SECRET dans docker-compose.yml
# Les secrets ne doivent pas être hardcodés dans ce fichier de configuration
oidc_issuer_url = "http://keycloak.localtest.me:8080/realms/oauth-starter"
redirect_url = "http://oauth2-proxy.localtest.me:4180/oauth2/callback"

# Configuration HTTP
http_address = "0.0.0.0:4180"

# Configuration des cookies
# Note : Les endpoints OAuth2 (/oauth2/start, /oauth2/sign_out) sont les valeurs par défaut
# cookie_secret : Géré via variable d'environnement OAUTH2_PROXY_COOKIE_SECRET dans docker-compose.yml
# Les secrets ne doivent pas être hardcodés dans ce fichier de configuration
cookie_httponly = true
cookie_secure = false  # false pour développement HTTP, true pour production HTTPS
cookie_samesite = "lax"  # "lax" permet l'envoi de cookies lors de redirections OAuth2, "strict" les bloque
# cookie_domain optionnel : si nécessaire pour partager les cookies entre sous-domaines
# cookie_domain = ".localtest.me"

# Configuration du stockage de session
session_store_type = "cookie"

# Configuration du routage upstream
# Les upstreams sont configurés ici pour permettre le routage basé sur les chemins
# - /api/* → http://api:80/api/* (API .NET)
# - / → http://app:80/ (front-end Vue.js)

upstreams = [
    "http://api:80/api/",
    "http://app:80/"
]

# Configuration email
email_domains = "*"

# Configuration OIDC
insecure_oidc_skip_issuer_verification = true  # true pour développement, false pour production

# Pour le dev uniquement : affichage des infos de debugs
show_debug_on_error = true

# Configuration du code challenge method
code_challenge_method = "S256"

# Configuration du passage du token JWT à l'API
# Feature 004 : Permet à oauth2-proxy de transmettre le token JWT d'accès dans l'en-tête Authorization
# aux requêtes upstream vers l'API pour la validation JWT
pass_access_token = true

# Pour le dev uniquement : permet l'utilisation d'email non vérifiés
# insecure_oidc_allow_unverified_email=true